<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Fornecedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css">
    <script src="script.js" defer></script>
    <style>
        .help-text {
            display: none;
            color: #6c757d;
            font-style: italic;
            margin-top: 0.25rem;
        }
        .form-check-input:checked + .form-check-label::before {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        #requestTime {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 10px;
        }
        #credits {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
        }
        #dataLoading {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin-top: 10px;
        }
        /* Estilo para o alerta de instabilidade */
        #apiAlert {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <main class="container mt-5">
        <h1 class="mb-4">Buscador de Fornecedores</h1>
        <p>Esta ferramenta foi elaborada com o intuito de facilitar a busca por cotações para licitações através da consulta de fornecedores previamentese cadastraram para participar de licitações. A consulta é feita ao banco de dados de empresas do governo federal disponível em <a href="https://compras.dados.gov.br/docs/home.html" target="_blank">API de Compras Governamentais</a>.</p>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="helpToggle">
            <label class="form-check-label" for="helpToggle">Exibir ajuda</label>
        </div>
        <div id="dataLoading">Carregando dados, aguarde alguns instantes...</div>
        <form id="searchForm" style="display: none;">
            <div class="mb-3">
                <label for="linhaFornecimento" class="form-label">Linha de Fornecimento</label>
                <select class="form-select" id="linhaFornecimento">
                    <option value="">Selecione uma linha de fornecimento</option>
                </select>
                <div class="help-text">Selecione a linha de fornecimento desejada. Você pode deixar em branco para buscar em todas as linhas.</div>
            </div>
            <div class="mb-3">
                <label for="uf" class="form-label">UF</label>
                <select class="form-select" id="uf">
                    <option value="">Selecione um estado</option>
                    <option value="AC">Acre</option>
                    <option value="AL">Alagoas</option>
                    <option value="AP">Amapá</option>
                    <option value="AM">Amazonas</option>
                    <option value="BA">Bahia</option>
                    <option value="CE">Ceará</option>
                    <option value="DF">Distrito Federal</option>
                    <option value="ES">Espírito Santo</option>
                    <option value="GO">Goiás</option>
                    <option value="MA">Maranhão</option>
                    <option value="MT">Mato Grosso</option>
                    <option value="MS">Mato Grosso do Sul</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="PA">Pará</option>
                    <option value="PB">Paraíba</option>
                    <option value="PR">Paraná</option>
                    <option value="PE">Pernambuco</option>
                    <option value="PI">Piauí</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="RN">Rio Grande do Norte</option>
                    <option value="RS">Rio Grande do Sul</option>
                    <option value="RO">Rondônia</option>
                    <option value="RR">Roraima</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="SP">São Paulo</option>
                    <option value="SE">Sergipe</option>
                    <option value="TO">Tocantins</option>
                </select>
                <div class="help-text">Escolha o estado desejado. Deixe em branco para buscar em todos os estados.</div>
            </div>
            <div class="mb-3">
                <label for="municipio" class="form-label">Município</label>
                <select class="form-select" id="municipio">
                    <option value="">Selecione um município</option>
                </select>
                <div class="help-text">Selecione o município desejado. Deixe em branco para buscar em todos os municípios.</div>
            </div>
            <div class="d-flex">
                <button type="submit" class="btn btn-primary me-2">Buscar</button>
                <button type="button" id="limparBtn" class="btn btn-secondary me-2">Limpar Seleções</button> <!-- Novo botão de limpar -->
                <button type="button" id="downloadBtn" class="btn btn-success btn-lg" disabled>Download CSV Completo</button>
            </div>
        </form>
        <div id="loading" class="mt-3">
            <img src="https://i.gifer.com/ZKZg.gif" alt="Carregando..." width="50" height="50">
            <div id="requestTime"></div>
            <!-- Alerta de instabilidade da API -->
            <div id="apiAlert" class="alert alert-warning" role="alert" style="opacity: 0.9;">
                <strong>Atenção!</strong> A API do governo está instável. Se os resultados não aparecerem em alguns segundos, recomendamos tentar novamente mais tarde.
            </div>
        </div>
        <div id="apiLink" class="mt-4"></div>
        <div id="results" class="mt-4"></div>
        <div id="credits" class="mt-4">
            <h5>Créditos e Informações</h5>
            <p>Esta calculadora foi desenvolvida por Erick C. Campos <a href="mailto:erick.campos@ufjf.br" target="_blank">erick.campos@ufjf.br</a> (mailto:erick.campos@ufjf.br), sendo disponibilizada sem nenhuma garantia. A utilização desta calculadora é de responsabilidade do usuário, e os resultados fornecidos são aproximados, com base nas informações disponíveis nas fontes mencionadas. </p>
        </div>
    </main>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#helpToggle').change(function() {
                $('.help-text').toggle(this.checked);
            });

            // Initialize Select2 for all select elements
            $('select').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: $(this).data('placeholder'),
                allowClear: true
            });

            // Load data from Google Sheets without blocking the application
            const sheetId = '1BaVTq3_Cb0Qih5K-FyqNQqmfuarVfq-Jj86hvYnvO2Q';
            const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=25459907`;

            fetch(sheetUrl)
                .then(response => response.text())
                .then(data => {
                    const lines = data.split('\n');
                    const linhasFornecimento = [];
                    const municipios = [];
                    lines.slice(1).forEach(line => {
                        const [linhaCode, municipioData] = line.split(',');
                        if (linhaCode) {
                            const match = linhaCode.match(/Linha de Fornecimento (\d+):\s*(.*)/);
                            if (match) {
                                const id = match[1];
                                const text = match[2];
                                linhasFornecimento.push({
                                    id: id.trim(),
                                    text: text.trim()
                                });
                            }
                        }
                        if (municipioData) {
                            const municipioMatch = municipioData.match(/Município (\d+):\s*(.*)/);
                            if (municipioMatch) {
                                const municipioId = municipioMatch[1];
                                const municipioName = municipioMatch[2];
                                municipios.push({
                                    id: municipioId.trim(),
                                    text: `${municipioId.trim()} - ${municipioName.trim()}`
                                });
                            }
                        }
                    });
                    populateSelect('#linhaFornecimento', linhasFornecimento);
                    populateSelect('#municipio', municipios);
                    $('#dataLoading').hide();
                    $('#searchForm').show();
                })
                .catch(error => {
                    console.error('Erro ao carregar dados do Google Sheets:', error);
                    alert('Erro ao carregar dados iniciais. Por favor, recarregue a página.');
                });

            function populateSelect(selector, options) {
                const select = $(selector);
                select.find('option:gt(0)').remove();
                options.forEach(option => {
                    select.append($('<option>', {
                        value: option.id,
                        text: option.text
                    }));
                });
                select.trigger('change'); // Update Select2
            }

            let requestTimer;
            let startTime;
            let alertaMostrado = false; // Flag para evitar múltiplos alertas

            $('#searchForm').submit(function(e) {
                e.preventDefault();
                
                const linhaFornecimento = $('#linhaFornecimento').val();
                const uf = $('#uf').val();
                const municipio = $('#municipio').val();
                
                let apiUrl = 'https://compras.dados.gov.br/fornecedores/v1/fornecedores.csv?';
                
                if (linhaFornecimento) apiUrl += `id_linha_fornecimento=${linhaFornecimento}&`;
                if (uf) apiUrl += `uf=${uf}&`;
                if (municipio) apiUrl += `id_municipio=${municipio}&`;
                
                // Remove trailing '&' se presente
                apiUrl = apiUrl.endsWith('&') ? apiUrl.slice(0, -1) : apiUrl;
                
                $('#apiLink').html(`<strong>Link da consulta:</strong> <a href="${apiUrl}" target="_blank">${apiUrl}</a>`);
                
                // Mostrar loading gif e iniciar timer
                $('#loading').show();
                $('#apiAlert').hide(); // Esconder alerta caso esteja visível de uma consulta anterior
                alertaMostrado = false; // Resetar flag do alerta
                startTime = new Date();
                requestTimer = setInterval(updateRequestTime, 100);
                
                $.ajax({ url: apiUrl, dataType: 'text' }).done(function(response) {
                    clearInterval(requestTimer);
                    $('#loading').hide(); // Esconder loading gif e tempo de requisição
                    const endTime = new Date();
                    const duration = (endTime - startTime) / 1000; // em segundos
                    
                    const allRows = response.split('\n');
                    const headers = allRows[0].split(',').map(header => header.trim());
                    const resultCount = Math.max(allRows.length - 2, 0); // Garantir que seja >= 0
                    
                    let tableHtml = `<h3>Resultados (${resultCount} encontrados, tempo de consulta: ${duration.toFixed(2)} segundos)</h3>`;
                    tableHtml += '<table id="resultsTable" class="table table-striped"><thead><tr>';
                    const selectedHeaders = ['CNPJ', 'Nome', 'Ativo', 'Município', 'Natureza Jurídica', 'Habilitado a Licitar', 'CNAE'];
                    const selectedIndexes = [];
                    headers.forEach((header, index) => {
                        if (selectedHeaders.includes(header)) {
                            tableHtml += `<th>${header === 'CNAE' ? 'CNAE principal' : header}</th>`;
                            selectedIndexes.push(index);
                        }
                    });
                    tableHtml += '</tr></thead><tbody>';
                    
                    for (let i = 1; i < allRows.length - 1; i++) {
                        const cells = parseCSVRow(allRows[i]);
                        tableHtml += '<tr>';
                        selectedIndexes.forEach(index => {
                            tableHtml += `<td>${cells[index]}</td>`;
                        });
                        tableHtml += '</tr>';
                    }
                    
                    tableHtml += '</tbody></table>';
                    
                    $('#results').html(tableHtml);
                    
                    // Inicializar DataTable com funcionalidades modernas
                    $('#resultsTable').DataTable({
                        responsive: true,
                        language: {
                            url:  '//cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json'
                        },
                        dom: 'Bfrtip',
                        buttons: [
                            'copy', 'csv', 'excel', 'pdf', 'print',
                            {
                                extend: 'colvis',
                                text: 'Exibir/Ocultar Colunas'
                            }
                        ],
                        order: [[1, 'asc']],
                        pageLength: 100,
                        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
                        columnDefs: [
                            { responsivePriority: 1, targets: 0 },
                            { responsivePriority: 2, targets: -1 }
                        ]
                    });
                    
                    // Habilitar botão de download e definir sua funcionalidade
                    $('#downloadBtn').prop('disabled', false).off('click').on('click', function() {
                        const blob = new Blob([response], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement("a");
                        if (link.download !== undefined) {
                            const url = URL.createObjectURL(blob);
                            link.setAttribute("href", url);
                            link.setAttribute("download", "fornecedores_completo.csv");
                            link.style.visibility = 'hidden';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }
                    });
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    clearInterval(requestTimer);
                    $('#loading').hide(); // Esconder loading gif e tempo de requisição
                    console.error('Erro ao buscar dados:', textStatus, errorThrown);
                    $('#results').text('Erro ao buscar dados. Por favor, tente novamente.');
                });
            });

            // Novo manipulador para o botão de limpar seleções
            $('#limparBtn').click(function() {
                // Resetar o formulário
                $('#searchForm')[0].reset();
                // Resetar os Select2
                $('select').val(null).trigger('change');
                // Esconder resultados e links anteriores
                $('#results').empty();
                $('#apiLink').empty();
                $('#downloadBtn').prop('disabled', true);
                // Esconder quaisquer alertas
                $('#apiAlert').hide();
                // Esconder textos de ajuda se estiverem visíveis
                if ($('#helpToggle').is(':checked')) {
                    $('.help-text').hide();
                    $('#helpToggle').prop('checked', false);
                }
            });

            function updateRequestTime() {
                const currentTime = new Date();
                const elapsedTime = (currentTime - startTime) / 1000; // em segundos
                $('#requestTime').text(`Tempo de requisição: ${elapsedTime.toFixed(1)} segundos`);

                // Verificar se o tempo ultrapassou 10 segundos e mostrar alerta se necessário
                if (elapsedTime > 10 && !alertaMostrado) {
                    $('#apiAlert').fadeIn();
                    alertaMostrado = true;
                }
            }

            function parseCSVRow(row) {
                const result = [];
                let inQuotes = false;
                let value = '';
                for (let char of row) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(value.trim());
                        value = '';
                    } else {
                        value += char;
                    }
                }
                result.push(value.trim());
                return result;
            }
        });
    </script>
</body>
</html>
