<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Fornecedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        .help-text {
            display: none;
            color: #6c757d;
            font-style: italic;
            margin-top: 0.25rem;
        }
        .form-check-input:checked + .form-check-label::before {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Buscador de Fornecedores</h1>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="helpToggle">
            <label class="form-check-label" for="helpToggle">Exibir ajuda</label>
        </div>
        <form id="searchForm">
            <div class="mb-3">
                <label for="linhaFornecimento" class="form-label">Linha de Fornecimento</label>
                <select class="form-select" id="linhaFornecimento">
                    <option value="">Selecione uma linha de fornecimento</option>
                </select>
                <div class="help-text">Selecione a linha de fornecimento desejada. Você pode deixar em branco para buscar em todas as linhas.</div>
            </div>
            <div class="mb-3">
                <label for="uf" class="form-label">UF</label>
                <select class="form-select" id="uf">
                    <option value="">Selecione um estado</option>
                    <option value="AC">Acre</option>
                    <option value="AL">Alagoas</option>
                    <option value="AP">Amapá</option>
                    <option value="AM">Amazonas</option>
                    <option value="BA">Bahia</option>
                    <option value="CE">Ceará</option>
                    <option value="DF">Distrito Federal</option>
                    <option value="ES">Espírito Santo</option>
                    <option value="GO">Goiás</option>
                    <option value="MA">Maranhão</option>
                    <option value="MT">Mato Grosso</option>
                    <option value="MS">Mato Grosso do Sul</option>
                    <option value="MG">Minas Gerais</option>
                    <option value="PA">Pará</option>
                    <option value="PB">Paraíba</option>
                    <option value="PR">Paraná</option>
                    <option value="PE">Pernambuco</option>
                    <option value="PI">Piauí</option>
                    <option value="RJ">Rio de Janeiro</option>
                    <option value="RN">Rio Grande do Norte</option>
                    <option value="RS">Rio Grande do Sul</option>
                    <option value="RO">Rondônia</option>
                    <option value="RR">Roraima</option>
                    <option value="SC">Santa Catarina</option>
                    <option value="SP">São Paulo</option>
                    <option value="SE">Sergipe</option>
                    <option value="TO">Tocantins</option>
                </select>
                <div class="help-text">Escolha o estado desejado. Deixe em branco para buscar em todos os estados.</div>
            </div>
            <div class="mb-3">
                <label for="municipio" class="form-label">Município</label>
                <select class="form-select" id="municipio">
                    <option value="">Selecione um município</option>
                </select>
                <div class="help-text">Selecione o município desejado. Deixe em branco para buscar em todos os municípios.</div>
            </div>
            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>
        <div id="apiLink" class="mt-4"></div>
        <div id="results" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#helpToggle').change(function() {
                $('.help-text').toggle(this.checked);
            });

            // Initialize Select2 for all select elements
            $('select').select2({
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: $(this).data('placeholder'),
                allowClear: true
            });

            // Load base_dados.csv
            $.ajax({
                url: 'base_dados.csv',
                dataType: 'text',
                success: function(data) {
                    const lines = data.split('\n');
                    const linhasFornecimento = [];
                    const municipios = [];
                    lines.forEach(line => {
                        const [linhaCode, linhaName, municipioCode, municipioName] = line.split(',');
                        if (linhaCode && linhaName) {
                            linhasFornecimento.push({
                                id: linhaCode.trim(),
                                text: `${linhaCode.trim()} - ${linhaName.trim()}`
                            });
                        }
                        if (municipioCode && municipioName) {
                            municipios.push({
                                id: municipioCode.trim(),
                                text: `${municipioCode.trim()} - ${municipioName.trim()}`
                            });
                        }
                    });
                    populateSelect('#linhaFornecimento', linhasFornecimento);
                    populateSelect('#municipio', municipios);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Erro ao carregar base_dados.csv:', textStatus, errorThrown);
                    alert('Erro ao carregar dados iniciais. Por favor, recarregue a página.');
                }
            });

            function populateSelect(selector, options) {
                const select = $(selector);
                select.find('option:gt(0)').remove();
                options.forEach(option => {
                    select.append($('<option>', {
                        value: option.id,
                        text: option.text
                    }));
                });
                select.trigger('change'); // Update Select2
            }

            $('#searchForm').submit(function(e) {
                e.preventDefault();
                
                const linhaFornecimento = $('#linhaFornecimento').val();
                const uf = $('#uf').val();
                const municipio = $('#municipio').val();
                
                let apiUrl = 'http://compras.dados.gov.br/fornecedores/v1/fornecedores.csv?';
                
                if (linhaFornecimento) apiUrl += `id_linha_fornecimento=${linhaFornecimento}&`;
                if (uf) apiUrl += `uf=${uf}&`;
                if (municipio) apiUrl += `id_municipio=${municipio}&`;
                
                // Remove trailing '&' if present
                apiUrl = apiUrl.endsWith('&') ? apiUrl.slice(0, -1) : apiUrl;
                
                $('#apiLink').html(`<strong>Link da consulta:</strong> <a href="${apiUrl}" target="_blank">${apiUrl}</a>`);
                
                const startTime = new Date();
                
                $.when(
                    $.ajax({ url: apiUrl, dataType: 'text' }),
                    $.ajax({ url: apiUrl + '&offset=500', dataType: 'text' })
                ).done(function(response1, response2) {
                    const endTime = new Date();
                    const duration = (endTime - startTime) / 1000; // in seconds
                    
                    const data1 = response1[0];
                    const data2 = response2[0];
                    
                    const rows1 = data1.split('\n');
                    const rows2 = data2.split('\n').slice(1); // Remove header from second response
                    const allRows = rows1.concat(rows2);
                    
                    const headers = allRows[0].split(',');
                    const resultCount = allRows.length - 2; // Subtract header and empty last row
                    
                    let tableHtml = `<h3>Resultados (${resultCount} encontrados, tempo de consulta: ${duration.toFixed(2)} segundos)</h3>`;
                    tableHtml += '<table id="resultsTable" class="table table-striped"><thead><tr>';
                    headers.forEach(header => {
                        tableHtml += `<th>${header}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    
                    for (let i = 1; i < allRows.length - 1; i++) {
                        const cells = allRows[i].split(',');
                        tableHtml += '<tr>';
                        cells.forEach(cell => {
                            tableHtml += `<td>${cell}</td>`;
                        });
                        tableHtml += '</tr>';
                    }
                    
                    tableHtml += '</tbody></table>';
                    
                    $('#results').html(tableHtml);
                    
                    // Initialize DataTable
                    $('#resultsTable').DataTable({
                        responsive: true,
                        language: {
                            url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json'
                        },
                        dom: 'Bfrtip',
                        buttons: [
                            'copy', 'csv', 'excel', 'pdf', 'print',
                            {
                                extend: 'colvis',
                                text: 'Exibir/Ocultar Colunas'
                            }
                        ]
                    });
                    
                    // Add download button for full dataset
                    const fullData = data1 + data2.substring(data2.indexOf('\n') + 1);
                    const downloadBtn = $('<a>', {
                        href: 'data:text/csv;charset=utf-8,' + encodeURIComponent(fullData),
                        download: 'fornecedores_completo.csv',
                        class: 'btn btn-success mt-3',
                        text: 'Baixar CSV Completo'
                    });
                    $('#results').append(downloadBtn);
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Erro ao buscar dados:', textStatus, errorThrown);
                    $('#results').text('Erro ao buscar dados. Por favor, tente novamente.');
                });
            });
        });
    </script>
</body>
</html>